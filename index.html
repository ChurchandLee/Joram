<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HeartoListen - AI Mental Wellbeing Support</title>
<meta name="description" content="Free AI-powered Mental Wellbeing Support Companion. Your 24/7 safe, private and judgement-free space for mental wellness.">
<meta name="theme-color" content="#8eaf78">

<!-- PWA and App Icon Meta Tags -->
<link rel="apple-touch-icon" sizes="180x180" href="https://raw.githubusercontent.com/ChurchandLee/ubiquitous-guacamole/main/earheart.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://raw.githubusercontent.com/ChurchandLee/ubiquitous-guacamole/main/earheart.png">
<link rel="icon" type="image/png" sizes="16x16" href="https://raw.githubusercontent.com/ChurchandLee/ubiquitous-guacamole/main/earheart.png">
<link rel="manifest" href="app-manifest.json">

<!-- iOS specific -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="HeartoListen">

<!-- Android specific -->
<meta name="mobile-web-app-capable" content="yes">

<style>
* {
margin: 0;
padding: 0;
box-sizing: border-box;
}

body {
font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
background: linear-gradient(135deg, #8eaf78 0%, #764ba2 100%);
min-height: 100vh;
display: flex;
align-items: center;
justify-content: center;
padding: 20px;
background-image: url('https://raw.githubusercontent.com/ChurchandLee/ubiquitous-guacamole/main/fern background.png');
}

.container {
width: 100%;
max-width: 800px;
background: rgba(255, 255, 255, 0.95);
border-radius: 20px;
box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
backdrop-filter: blur(10px);
overflow: hidden;
display: flex;
flex-direction: column;
height: 700px;
}

.logo-header {
background: linear-gradient(135deg, #5f795a 0%, #4CAF50 100%);
padding: 25px;
text-align: center;
color: white;
border-bottom: 3px solid rgba(255, 255, 255, 0.2);
transition: all 0.3s ease;
}

/* Compact header state */
.logo-header.compact {
padding: 15px;
}

.logo {
width: 150px;
height: 150px;
margin: 0 auto 15px auto;
transition: all 0.3s ease;
display: flex;
align-items: center;
justify-content: center;
overflow: hidden;
position: relative;
}

/* Compact logo state */
.logo-header.compact .logo {
width: 60px;
height: 60px;
margin: 0 auto;
}

.logo:hover {
transform: scale(1.05);
}

.logo-header h1 {
font-size: 2.2em;
margin-bottom: 8px;
font-weight: 700;
text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
transition: all 0.3s ease;
}

.logo-header p {
opacity: 0.95;
font-size: 1.1em;
font-weight: 500;
transition: all 0.3s ease;
}

/* Hide text in compact mode */
.logo-header.compact h1,
.logo-header.compact p {
display: none;
}

.chat-area {
flex: 1;
overflow-y: auto;
padding: 20px;
display: flex;
flex-direction: column;
gap: 15px;
background: linear-gradient(to bottom, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
}

.message {
max-width: 85%;
padding: 15px 20px;
border-radius: 18px;
animation: fadeIn 0.3s ease-out;
line-height: 1.6;
font-size: 15px;
white-space: pre-wrap;
}

.ai-message {
background: linear-gradient(135deg, #e8f5e8 0%, #f0f8ff 100%);
color: #274e13;
align-self: flex-start;
border-left: 4px solid #4CAF50;
box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
display: flex;
align-items: flex-start;
gap: 12px;
padding: 15px 20px;
}

.ai-message-content {
flex: 1;
line-height: 1.6;
}

.ai-avatar {
width: 50px;
height: 50px;
border-radius: 50%;
border: 2px solid rgba(76, 175, 80, 0.3);
object-fit: cover;
object-position: center;
flex-shrink: 0;
}

.user-message {
background: linear-gradient(135deg, #8eaf78 0%, #45a049 100%);
color: white;
align-self: flex-end;
box-shadow: 0 4px 12px rgba(46, 139, 87, 0.3);
}

.error-message {
background: linear-gradient(135deg, #ffebee 0%, #fce4ec 100%);
color: #c62828;
align-self: flex-start;
border-left: 4px solid #f44336;
box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
}

.thinking-heart {
font-size: 24px;
animation: heartPulse 1.5s ease-in-out infinite;
display: flex;
justify-content: center;
align-items: center;
}

.welcome-section {
text-align: center;
margin: 20px 0;
padding: 25px;
background: linear-gradient(135deg, rgba(76, 175, 80, 0.08) 0%, rgba(139, 195, 74, 0.08) 100%);
border-radius: 15px;
border: 2px dashed rgba(76, 175, 80, 0.2);
}

.welcome-section h2 {
color: #8eaf78;
font-size: 1.4em;
margin-bottom: 10px;
font-weight: 600;
}

.welcome-section p {
color: #5a6c57;
line-height: 1.6;
margin-bottom: 15px;
}

/* Memory recap section */
.memory-recap {
background: linear-gradient(135deg, rgba(142, 175, 120, 0.08) 0%, rgba(255, 223, 186, 0.08) 100%);
border: 2px dashed rgba(142, 175, 120, 0.3);
border-radius: 12px;
padding: 15px;
margin: 15px 0;
font-size: 13px;
color: #5a6c57;
text-align: left;
}

.memory-recap h4 {
color: #8eaf78;
margin-bottom: 10px;
font-size: 14px;
display: flex;
align-items: center;
gap: 8px;
}

.memory-recap ul {
padding-left: 20px;
margin: 0;
}

.memory-recap li {
margin-bottom: 5px;
line-height: 1.4;
}

.disclaimer {
background: linear-gradient(135deg, #fff8dc 0%, #ffeaa7 100%);
border: 2px solid #f39c12;
border-radius: 12px;
padding: 15px;
margin: 15px 0;
font-size: 13px;
color: #8b4513;
text-align: center;
font-weight: 500;
}

.input-area {
padding: 20px;
background: rgba(255, 255, 255, 0.95);
border-top: 1px solid rgba(0, 0, 0, 0.1);
display: flex;
gap: 15px;
align-items: center;
}

.input-field {
flex: 1;
padding: 15px 20px;
border: 2px solid #e0e0e0;
border-radius: 25px;
font-size: 14px;
outline: none;
transition: all 0.3s ease;
background: white;
font-family: inherit;
}

.input-field:focus {
border-color: #4CAF50;
box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
}

.send-button {
padding: 15px 25px;
background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
color: white;
border: none;
border-radius: 25px;
cursor: pointer;
font-size: 16px;
font-weight: 600;
transition: all 0.3s ease;
min-width: 80px;
}

.send-button:hover {
transform: translateY(-2px);
box-shadow: 0 10px 25px rgba(76, 175, 80, 0.3);
}

.send-button:active {
transform: translateY(0);
}

.send-button:disabled {
opacity: 0.6;
cursor: not-allowed;
transform: none;
}

@keyframes fadeIn {
from {
opacity: 0;
transform: translateY(10px);
}
to {
opacity: 1;
transform: translateY(0);
}
}

@keyframes heartPulse {
0%, 100% {
transform: scale(1);
opacity: 0.8;
}
50% {
transform: scale(1.3);
opacity: 1;
}
}

/* Responsive design */
@media (max-width: 600px) {
.container {
height: 90vh;
margin: 10px;
}

.logo {
width: 120px;
height: 120px;
}

.logo-header.compact .logo {
width: 50px;
height: 50px;
}

.logo-header h1 {
font-size: 1.8em;
}

.message {
max-width: 95%;
}
}

/* DISCLAIMER MODAL STYLES */
.disclaimer-overlay {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background: rgba(0, 0, 0, 0.8);
z-index: 3000;
display: flex;
align-items: center;
justify-content: center;
padding: 20px;
backdrop-filter: blur(5px);
}

.disclaimer-modal {
background: white;
border-radius: 20px;
padding: 30px;
max-width: 600px;
width: 100%;
max-height: 80vh;
overflow-y: auto;
text-align: left;
box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
animation: disclaimerSlideIn 0.4s ease-out;
border: 3px solid #8eaf78;
}

.disclaimer-modal h2 {
color: #8eaf78;
text-align: center;
margin-bottom: 25px;
font-size: 1.8em;
font-weight: 700;
}

.disclaimer-modal .warning-icon {
text-align: center;
font-size: 3em;
margin-bottom: 15px;
}

.disclaimer-content {
color: #333;
line-height: 1.6;
font-size: 14px;
}

.disclaimer-content p {
margin-bottom: 15px;
}

.disclaimer-content strong {
color: #2c5530;
font-weight: 600;
}

.emergency-section {
background: linear-gradient(135deg, #ffebee 0%, #fce4ec 100%);
border: 2px solid #e91e63;
border-radius: 12px;
padding: 20px;
margin: 20px 0;
}

.emergency-section h3 {
color: #c2185b;
margin-bottom: 15px;
font-size: 1.2em;
display: flex;
align-items: center;
gap: 10px;
}

.emergency-contacts {
margin: 15px 0;
padding-left: 20px;
}

.emergency-contacts li {
margin-bottom: 8px;
color: #880e4f;
font-weight: 500;
}

.important-notes {
background: linear-gradient(135deg, #fff8dc 0%, #ffeaa7 100%);
border: 2px solid #f39c12;
border-radius: 12px;
padding: 20px;
margin: 20px 0;
}

.important-notes h3 {
color: #e67e22;
margin-bottom: 15px;
font-size: 1.2em;
display: flex;
align-items: center;
gap: 10px;
}

.important-notes ul {
padding-left: 20px;
}

.important-notes li {
margin-bottom: 8px;
color: #8b4513;
}

.disclaimer-buttons {
display: flex;
gap: 15px;
justify-content: center;
margin-top: 30px;
flex-wrap: wrap;
}

.btn-accept {
background: linear-gradient(135deg, #8eaf78 0%, #45a049 100%);
color: white;
border: none;
padding: 15px 30px;
border-radius: 25px;
cursor: pointer;
font-size: 16px;
font-weight: 600;
transition: all 0.3s ease;
min-width: 180px;
}

.btn-accept:hover {
transform: translateY(-2px);
box-shadow: 0 10px 25px rgba(142, 175, 120, 0.3);
}

.btn-help {
background: linear-gradient(135deg, #e91e63 0%, #c2185b 100%);
color: white;
border: none;
padding: 15px 30px;
border-radius: 25px;
cursor: pointer;
font-size: 16px;
font-weight: 600;
transition: all 0.3s ease;
min-width: 180px;
}

.btn-help:hover {
transform: translateY(-2px);
box-shadow: 0 10px 25px rgba(233, 30, 99, 0.3);
}

@keyframes disclaimerSlideIn {
from {
opacity: 0;
transform: translateY(-50px) scale(0.9);
}
to {
opacity: 1;
transform: translateY(0) scale(1);
}
}

/* Mobile responsiveness */
@media (max-width: 600px) {
.disclaimer-modal {
padding: 20px;
margin: 10px;
max-height: 90vh;
}

.disclaimer-modal h2 {
font-size: 1.5em;
}

.disclaimer-content {
font-size: 13px;
}

.disclaimer-buttons {
flex-direction: column;
align-items: center;
}

.btn-accept,
.btn-help {
width: 100%;
max-width: 250px;
}
}

.hidden {
display: none !important;
}
</style>
</head>
<body>
<!-- DISCLAIMER MODAL -->
<div id="disclaimerOverlay" class="disclaimer-overlay hidden">
<div class="disclaimer-modal">
<div class="warning-icon">‚ö†Ô∏è</div>
<h2>Important Disclaimer</h2>

<div class="disclaimer-content">
<p><strong>This app is designed to provide emotional support, encouragement, and validation. It is not a substitute for professional medical, psychiatric, or psychological treatment.</strong></p>

<p>The content and features within this app are for general well-being, personal growth, and self-reflection purposes only. We are not medical professionals, and this app does not offer medical, clinical, or therapeutic advice.</p>

<p>If you are experiencing significant distress, a mental health crisis, or believe you may have a condition requiring diagnosis or treatment, please seek help from a qualified healthcare provider.</p>

<div class="important-notes">
<h3>üìã Important Notes</h3>
<ul>
<li>The app does not provide diagnosis, treatment, prescriptions, or medical interventions.</li>
<li>Use of this app is voluntary and should be considered a complementary tool to professional care, not a replacement.</li>
<li>Any decisions you make based on the information, tools, or suggestions provided are your personal responsibility.</li>
</ul>
</div>

<p><strong>By using this app, you acknowledge and agree that it is intended to provide support, validation, and helpful resources, but it cannot and does not replace the care of licensed professionals.</strong></p>
</div>

<div class="disclaimer-buttons">
<button class="btn-accept" onclick="acceptDisclaimer()">I Understand & Agree</button>
<button class="btn-help" onclick="getNeedHelpNow()">I Need Help Now</button>
</div>

<div class="emergency-section">
<h3>üö® Emergency Situations</h3>
<p><strong>If you are in immediate danger or experiencing thoughts of harming yourself or others, please call your local emergency number right away.</strong></p>

<ul class="emergency-contacts">
<li><strong>In the U.S.:</strong> you can dial 988 for the Suicide & Crisis Lifeline</li>
<li><strong>In the U.K. & Ireland:</strong> you can call Samaritans at 116 123</li>
<li><strong>In Australia:</strong> you can call Lifeline at 13 11 14</li>
</ul>

<p>If you are outside these regions, please look up local emergency and crisis services in your area.</p>
</div>
</div>
</div>

<div class="container">
<!-- Logo Header Section -->
<div class="logo-header" id="logoHeader">
<div class="logo">
<img src="https://raw.githubusercontent.com/ChurchandLee/ubiquitous-guacamole/main/earheart.png" alt="HeartoListen Logo" style="width: 100%; height: 100%; object-fit: contain; position: relative; z-index: 10;">
</div> 
<h1>HeartoListen</h1>
<p>AI Mental Wellbeing Support - Self Discovery for Positive Mental Health</p>
</div>

<!-- Chat Area -->
<div class="chat-area" id="chatArea">
<!-- Welcome Message -->
<div class="welcome-section" id="welcomeSection">
<h2>Welcome to Hear to Listen</h2>
<div style="display: flex; align-items: center; gap: 15px; margin: 15px 0;">
<img src="https://raw.githubusercontent.com/ChurchandLee/ubiquitous-guacamole/main/Eden.png" alt="Eden Avatar" style="width: 80px; height: 80px; border-radius: 50%; border: 3px solid rgba(76, 175, 80, 0.3); object-fit: cover; object-position: center;">
<p style="margin: 0;">I'm Eden and I am here to listen and support you through whatever you're experiencing. This is a safe, judgement-free space where you can share your thoughts and feelings.</p>
</div>

<!-- Memory Recap Section (hidden initially) -->
<div class="memory-recap" id="memoryRecap" style="display: none;">
<h4>Previous conversations:</h4>
<ul id="memoryList"></ul>
</div>

<!-- Important Disclaimer -->
<div class="disclaimer">
<strong>‚ö†Ô∏è Important Safety Information:</strong>
<br><br>
<strong>Crisis Support:</strong> If you're having thoughts of suicide or self-harm, please reach out immediately:
<br>‚Ä¢ <strong>UK:</strong> 999 (Emergency) | 116 123 (Samaritans - 24/7 free)
<br>‚Ä¢ <strong>USA:</strong> 911 (Emergency) | 988 (Suicide & Crisis Lifeline)
<br>‚Ä¢ <strong>Crisis Text:</strong> Text HOME to 741741
<br><br>
<strong>This app provides peer support and guidance, not professional medical advice.</strong> For ongoing mental health concerns, please seek professional Mental Wellbeing Support
</div>
</div>
</div>

<!-- Input Area -->
<div class="input-area">
<input type="text" 
id="messageInput" 
class="input-field" 
placeholder="What's on your mind......" 
onkeypress="handleKeyPress(event)">
<button id="sendButton" class="send-button" onclick="sendMessage()">Send</button>
</div>
</div>

<script>
// ENHANCED MEMORY SYSTEM
let sessionMemories = [];
let responseHistory = [];
const MAX_MEMORIES = 15;
const MAX_RESPONSE_HISTORY = 50;

// Enhanced memory with emotional context
function saveMemory(userMessage, aiResponse, detectedCondition = null, emotionalTone = null) {
const newMemory = {
id: Date.now(),
date: new Date().toISOString(),
userMessage: userMessage,
aiResponse: aiResponse,
detectedCondition: detectedCondition,
emotionalTone: emotionalTone,
timestamp: Date.now(),
keyTopics: extractKeyTopics(userMessage)
};

sessionMemories.unshift(newMemory);
sessionMemories = sessionMemories.slice(0, MAX_MEMORIES);

// Track response patterns to avoid repetition
responseHistory.push(aiResponse);
responseHistory = responseHistory.slice(-MAX_RESPONSE_HISTORY);
}

function extractKeyTopics(message) {
const lowerMessage = message.toLowerCase();
const topics = [];

// Extract key themes and topics
if (lowerMessage.includes('work') || lowerMessage.includes('job')) topics.push('work');
if (lowerMessage.includes('relationship') || lowerMessage.includes('partner') || lowerMessage.includes('boyfriend') || lowerMessage.includes('girlfriend')) topics.push('relationships');
if (lowerMessage.includes('family') || lowerMessage.includes('parents') || lowerMessage.includes('mother') || lowerMessage.includes('father')) topics.push('family');
if (lowerMessage.includes('school') || lowerMessage.includes('university') || lowerMessage.includes('study')) topics.push('education');
if (lowerMessage.includes('sleep') || lowerMessage.includes('insomnia') || lowerMessage.includes('tired')) topics.push('sleep');
if (lowerMessage.includes('eating') || lowerMessage.includes('food') || lowerMessage.includes('appetite')) topics.push('eating');

return topics;
}

function getMemories() {
return sessionMemories || [];
}

function hasRecentlySaidSimilar(newResponse) {
if (responseHistory.length === 0) return false;

const recent = responseHistory.slice(-5);
return recent.some(prev => {
const similarity = calculateSimilarity(newResponse, prev);
return similarity > 0.7; // 70% similarity threshold
});
}

function calculateSimilarity(str1, str2) {
const words1 = str1.toLowerCase().split(' ');
const words2 = str2.toLowerCase().split(' ');
const commonWords = words1.filter(word => words2.includes(word));
return commonWords.length / Math.max(words1.length, words2.length);
}

// ENHANCED MENTAL HEALTH CONDITION DETECTION
function detectMentalHealthCondition(message) {
const lowerMessage = message.toLowerCase();
const conditions = [];

// 1. Depression
if (lowerMessage.match(/\b(depressed|depression|hopeless|worthless|empty|numb|sad|down|low|can't feel|lost interest|nothing matters|pointless|exhausted|tired all the time)\b/)) {
conditions.push('depression');
}

// 2. Anxiety Disorders
if (lowerMessage.match(/\b(anxious|anxiety|panic|worried|nervous|scared|afraid|fear|racing heart|can't breathe|overwhelming|catastrophic thinking|what if)\b/)) {
conditions.push('anxiety');
}

// 3. PTSD/Trauma
if (lowerMessage.match(/\b(trauma|ptsd|flashbacks|nightmares|triggered|hypervigilant|dissociate|reliving|avoidance|jumpiness)\b/)) {
conditions.push('ptsd');
}

// 4. ADHD
if (lowerMessage.match(/\b(adhd|add|can't focus|distracted|hyperactive|impulsive|scattered|procrastinate|forgetful|restless)\b/)) {
conditions.push('adhd');
}

// 5. Bipolar Disorder
if (lowerMessage.match(/\b(bipolar|manic|mania|mood swings|euphoric|grandiose|racing thoughts|hypomanic|cycling|extreme mood)\b/)) {
conditions.push('bipolar');
}

// 6. Eating Disorders
if (lowerMessage.match(/\b(anorexia|bulimia|binge|purge|eating disorder|body image|fat|ugly|restrict|calories|weight|food anxiety)\b/)) {
conditions.push('eating_disorder');
}

// 7. OCD
if (lowerMessage.match(/\b(ocd|obsessive|compulsive|intrusive thoughts|checking|washing|rituals|contamination|symmetry|perfectionism)\b/)) {
conditions.push('ocd');
}

// 8. Social Anxiety
if (lowerMessage.match(/\b(social anxiety|shy|embarrassed|judged|public speaking|awkward|self-conscious|blushing|avoiding people)\b/)) {
conditions.push('social_anxiety');
}

// 9. Borderline Personality Disorder
if (lowerMessage.match(/\b(bpd|borderline|abandonment|unstable|identity crisis|emotional roller coaster|splitting|self-harm|unstable relationships)\b/)) {
conditions.push('bpd');
}

// 10. Autism Spectrum
if (lowerMessage.match(/\b(autism|autistic|aspergers|sensory|overwhelmed by noise|social cues|stimming|routine|change is hard|masking)\b/)) {
conditions.push('autism');
}

// 11. Substance Use Issues
if (lowerMessage.match(/\b(addiction|alcoholic|drinking too much|drugs|substance|rehab|sober|withdrawal|cravings|relapse)\b/)) {
conditions.push('substance_use');
}

// 12. Grief/Loss
if (lowerMessage.match(/\b(grief|grieving|loss|died|death|funeral|miss them|gone|mourning|bereavement)\b/)) {
conditions.push('grief');
}

return conditions;
}

// ENHANCED RESPONSE GENERATION SYSTEM
function generateEnhancedResponse(userMessage, conversationHistory = []) {
const memories = getMemories();
const hasMemories = memories.length > 0;
const detectedConditions = detectMentalHealthCondition(userMessage);
const primaryCondition = detectedConditions[0] || 'general';

// Generate contextual understanding
const context = analyzeContext(userMessage, memories);

let selectedResponse;
let attempts = 0;
const maxAttempts = 5;

do {
selectedResponse = selectResponse(primaryCondition, context, hasMemories);
attempts++;
} while (hasRecentlySaidSimilar(selectedResponse) && attempts < maxAttempts);

return {
choices: [{
message: {
content: selectedResponse
}
}]
};
}

function analyzeContext(message, memories) {
const context = {
isFirstTime: memories.length === 0,
recentConditions: memories.slice(0, 3).map(m => m.detectedCondition).filter(Boolean),
keyTopics: extractKeyTopics(message),
emotionalProgression: memories.slice(0, 5).map(m => m.emotionalTone).filter(Boolean),
timeOfDay: new Date().getHours(),
messageLength: message.length,
urgencyLevel: assessUrgency(message)
};

return context;
}

function assessUrgency(message) {
const urgentWords = ['crisis', 'emergency', 'help', 'can\'t cope', 'breaking down', 'desperate', 'urgent'];
const urgentCount = urgentWords.filter(word => message.toLowerCase().includes(word)).length;
return urgentCount > 0 ? 'high' : 'normal';
}

function selectResponse(condition, context, hasMemories) {
const responses = getResponseBank();
const conditionResponses = responses[condition] || responses['general'];

// Filter by memory status
const appropriateResponses = hasMemories ? 
(conditionResponses.returning || conditionResponses.first_time) : 
conditionResponses.first_time;

// Add contextual personalization
let selectedResponse = appropriateResponses[Math.floor(Math.random() * appropriateResponses.length)];

// Add contextual elements based on time, topics, etc.
selectedResponse = personalizeResponse(selectedResponse, context);

return selectedResponse;
}

function personalizeResponse(response, context) {
// Add time-sensitive elements
if (context.timeOfDay < 12) {
response = response.replace(/today/g, 'this morning');
} else if (context.timeOfDay > 18) {
response = response.replace(/today/g, 'this evening');
}

// Add topic-specific elements
if (context.keyTopics.includes('work')) {
response += " Work stress can really take a toll on our mental health.";
}

return response;
}

// COMPREHENSIVE RESPONSE BANK FOR 12 MENTAL HEALTH CONDITIONS
function getResponseBank() {
return {
depression: {
first_time: [
"I can hear such deep pain in what you're sharing. Depression can make everything feel heavy and colorless, like you're looking at the world through gray glass. What does a typical day feel like for you right now? Sometimes just describing the weight can help us understand it better.",

"That emptiness you're describing sounds absolutely exhausting. When depression settles in, it can feel like you're carrying invisible weights that no one else can see. What time of day tends to feel hardest for you? Are there moments, even tiny ones, where the heaviness lifts slightly?",

"The sadness you're describing sounds so profound. Depression often feels like being underwater - everything is muffled and harder to reach. What pulls you down most during your darkest moments? I'm wondering if there are specific thoughts or situations that seem to trigger this heaviness.",

"When you mention feeling depressed, I can sense there's real suffering behind those words. Sometimes depression whispers lies about our worth and our future. What has depression been telling you about yourself lately? And more importantly, what part of you still doubts those harsh inner voices?"
],

returning: [
"I'm really glad you came back to talk. I remember you sharing about feeling depressed before, and I've been thinking about you. How has that heavy feeling been treating you since we last spoke? Has anything shifted, even in small ways?",

"Seeing you return here takes courage, especially when depression makes everything feel pointless. I remember the weight you described carrying. Is it feeling similar today, or has the depression taken on a different character? Sometimes our relationship with these feelings evolves.",

"Thank you for trusting me with your ongoing struggle. I recall you mentioning feeling empty and disconnected. How are you experiencing that numbness now? Are there moments where you can still access parts of yourself, or does everything still feel distant?"
]
},

anxiety: {
first_time: [
"The anxiety you're describing sounds intense and consuming. When anxiety takes hold, it can feel like your mind is constantly scanning for danger, even when you're safe. What does the worry look like in your daily life? Are there specific thoughts that circle around and around?",

"I can almost feel the tension radiating from your words. Anxiety has this way of hijacking our nervous system and making everything feel urgent and threatening. What physical sensations do you notice when the anxiety peaks? Sometimes our bodies hold clues about what we're really afraid of.",

"That fearfulness sounds exhausting to carry. Anxiety often stems from our mind trying to protect us, but it can become overprotective to the point where it imprisons us. What situations or thoughts seem to trigger your anxiety most? What is your mind trying to keep you safe from?",

"The racing thoughts you're experiencing sound overwhelming. When anxiety spirals, it can feel like being trapped in a tornado of 'what-ifs.' What fears seem to shout the loudest in your mind? Sometimes anxiety masks deeper concerns about control, safety, or belonging."
],

returning: [
"I remember you sharing about anxiety before, and I can hear it's still very present for you. How have you been managing those racing thoughts since we last talked? Have you noticed any patterns in what triggers the anxiety?",

"It sounds like anxiety is still visiting you regularly. I recall you mentioning specific worries before - are these similar concerns, or has your anxiety found new things to focus on? Sometimes understanding the patterns can help us find ways to respond differently.",

"I'm glad you feel comfortable coming back to discuss your anxiety with me. From what I remember, certain situations really activated your nervous system. How has your relationship with those anxious feelings evolved? Are there times when you can observe the anxiety without being completely consumed by it?"
]
},

ptsd: {
first_time: [
"What you're describing sounds like trauma is still very much alive in your system. Trauma has this way of keeping us stuck in survival mode, even when the danger has passed. Are you finding that certain triggers transport you back to difficult times? Your nervous system is trying to protect you, but it sounds like it's working overtime.",

"I can hear how much pain you're carrying from past experiences. Trauma can make the world feel unpredictable and unsafe, even in moments that should be peaceful. What helps you feel most grounded when those memories or sensations surface? Sometimes our bodies remember what our minds try to forget.",

"The hypervigilance you're describing makes complete sense given what you've been through. When we've experienced trauma, our alarm system can get stuck in the 'on' position. What does safety look like for you right now? Are there people, places, or activities that help your nervous system remember it can relax?"
],

returning: [
"I remember you sharing about trauma before, and I can hear it's still impacting you deeply. How have you been managing those intense moments when the past feels present? Have you noticed any changes in how your body responds to triggers?",

"Thank you for continuing to trust me with your trauma experience. I recall how vivid and overwhelming those memories can be for you. How are you finding ways to stay grounded in the present moment?",

"I've been thinking about our previous conversation regarding your trauma. How has your sense of safety been since we last talked? Sometimes healing isn't linear, and I'm curious about what your journey has looked like recently."
]
},

adhd: {
first_time: [
"The scattered, restless feeling you're describing sounds so familiar to many people with ADHD. It's like your brain is a browser with 47 tabs open, and half of them are playing music. What's the most frustrating part of how your mind works differently? Sometimes understanding our unique wiring can help us work with it instead of against it.",

"That executive dysfunction you're experiencing sounds incredibly frustrating. ADHD can make simple tasks feel like climbing mountains, while complex, interesting things feel effortless. What aspects of daily life feel most derailed by your brain's different operating system? You're not lazy or broken - your brain just processes the world differently.",

"The focus struggles you're describing make so much sense. ADHD brains often crave stimulation and novelty, which can make routine tasks feel impossible while hyperfocus kicks in at unexpected times. When do you notice your attention working best? Understanding your natural rhythms can be really helpful."
],

returning: [
"I remember you mentioning ADHD challenges before. How has managing your focus and energy been lately? Have you discovered any strategies that work with your brain's natural patterns rather than fighting against them?",

"Good to see you back. I recall you sharing frustrations about executive function and staying organized. How has that been going? Sometimes ADHD management is about finding systems that match how our brains actually work, not how we think they should work.",

"I remember our conversation about ADHD and how exhausting it can be to navigate a world designed for neurotypical brains. What's been your biggest challenge lately? Are there areas where you're finding your ADHD traits are actually strengths?"
]
},

bipolar: {
first_time: [
"The mood cycles you're describing sound incredibly disorienting. Bipolar can feel like being on an emotional roller coaster you never bought a ticket for. Are you currently in a depressive phase, manic episode, or somewhere in between? Understanding where you are in the cycle can help us think about what kind of support might be most helpful right now.",

"Those extreme mood swings sound exhausting to navigate. When you're in a manic state, does it feel exciting and productive, or more chaotic and out of control? And when the depression hits, how deep does that crash feel? The whiplash between these states can be so disorienting.",

"The intensity you're describing in your moods sounds overwhelming. Bipolar can make you feel like you're living at the extremes, with very little middle ground. What does stability look like for you, and how often do you get to experience it? Sometimes even recognizing these patterns is an important step."
],

returning: [
"I remember you sharing about bipolar episodes before. Where are you in your cycle right now? I recall how dramatically different you felt between our conversations - it must be exhausting to navigate those shifts.",

"Thanks for checking back in. I remember how unpredictable your moods have been feeling. Are you currently managing a particular phase, or are you in a more stable period? How has your support system been during these fluctuations?",

"I've been wondering how you've been managing your bipolar symptoms since we last talked. I remember the intensity of both the highs and lows you described. What strategies have been helping you navigate the mood cycles?"
]
},

eating_disorder: {
first_time: [
"The relationship with food and your body that you're describing sounds so painful and complicated. Eating disorders often aren't really about food at all - they're usually about control, perfectionism, trauma, or other deep emotional needs. What do you think your eating patterns are trying to help you manage or control? There's often wisdom hidden in our symptoms.",

"I can hear how much distress your relationship with food and body image is causing. Eating disorders can feel like having a harsh critic living in your head, commenting on every bite and every reflection. What does that inner voice sound like, and how long has it been this loud? You deserve to have peace with food and your body.",

"The struggle you're describing with food sounds isolating and exhausting. Eating disorders thrive in secrecy and shame, making it even harder to reach out. What feels riskiest about recovery or changing these patterns? Sometimes understanding our fears about getting better can help us address them with compassion."
],

returning: [
"I remember how difficult your relationship with food has been. How are you feeling about eating and your body today? I know this is an ongoing struggle, and I'm wondering if anything has shifted in how you're managing these challenging thoughts and behaviors.",

"Thank you for continuing to trust me with something so personal and difficult. I recall the internal battle you described around food and body image. How has that critical inner voice been lately? Are there moments where you can challenge it or find some self-compassion?",

"I've been thinking about your eating disorder recovery since we last spoke. I remember how trapped you felt in those patterns. Are you finding any freedom or flexibility in your relationship with food, or are things feeling just as rigid?"
]
},

ocd: {
first_time: [
"The intrusive thoughts and compulsions you're describing sound absolutely exhausting. OCD can feel like being trapped in a prison made of your own thoughts, where the key to freedom seems to be doing just one more ritual. What thoughts visit you most persistently? And what compulsions feel most urgent or impossible to resist?",

"I can sense how much these obsessive patterns are controlling your daily life. OCD often convinces us that if we just check one more time, wash our hands once more, or arrange things perfectly, then we'll finally feel safe. But that relief never seems to last, does it? What does your OCD tell you will happen if you don't complete the rituals?",

"The mental loops you're stuck in sound incredibly distressing. OCD has this cruel way of making us doubt our own perceptions and judgment. What areas of your life feel most hijacked by these obsessive thoughts? Sometimes recognizing that these are OCD thoughts, not 'you' thoughts, can be the first step toward freedom."
],

returning: [
"I remember you sharing about OCD intrusions before. How have those persistent thoughts been treating you lately? Are you finding any success in distinguishing between your authentic thoughts and the OCD chatter?",

"Good to hear from you again. I recall how consuming those compulsive patterns were for you. Have you been able to experiment with any exposure exercises or found ways to tolerate the anxiety without completing rituals?",

"I remember how frustrated you felt being trapped by OCD. How has your relationship with those intrusive thoughts evolved? Sometimes recovery isn't about stopping the thoughts but changing how we respond to them."
]
},

social_anxiety: {
first_time: [
"The social fear you're describing sounds incredibly isolating. Social anxiety can make every interaction feel like a performance where everyone is judging and finding you lacking. What social situations feel most dangerous to you? Sometimes understanding our specific triggers can help us approach them differently.",

"I can hear how much energy you spend worrying about what others think. Social anxiety often stems from a deep fear of rejection or humiliation, and it can make us hyper-aware of every facial expression and tone of voice. What do you imagine people are thinking about you when you're in social situations?",

"That self-consciousness sounds so painful and limiting. Social anxiety can make us feel like we're constantly under a microscope, when in reality most people are too focused on themselves to scrutinize us as much as we fear. What would social interactions feel like if you knew for certain that people weren't judging you?"
],

returning: [
"I remember how challenging social situations have been for you. How has that self-consciousness been lately? Have you been able to experiment with any social interactions, even small ones?",

"Thanks for coming back to talk about social anxiety. I recall how exhausting it felt to constantly worry about judgment. Are you finding any situations where that hypervigilance relaxes slightly?",

"I remember the social fear you described before. How has your relationship with other people's opinions been evolving? Sometimes social anxiety recovery involves slowly building evidence that we can handle social risks."
]
},

bpd: {
first_time: [
"The emotional intensity you're describing sounds incredibly overwhelming. BPD can feel like experiencing emotions at 150% volume, where everything feels urgent and extreme. What triggers seem to send your emotions into overdrive? Sometimes understanding our patterns can help us develop better coping strategies.",

"I can hear how much pain you're in around relationships and your sense of self. BPD often stems from early experiences that taught us the world isn't safe and people will leave. What does abandonment feel like for you? And what helps you remember your own worth when everything feels chaotic?",

"The identity confusion you're experiencing sounds so disorienting. BPD can make us feel like we're constantly shape-shifting depending on who we're with, never quite sure who we really are. What feels most authentic about yourself, even when everything else feels uncertain?"
],

returning: [
"I remember the emotional intensity you've shared before. How have you been managing those overwhelming feelings? Have you been able to practice any distress tolerance skills when emotions feel all-consuming?",

"Thank you for continuing to share with me. I recall how challenging relationships and abandonment fears have been for you. How has your sense of self been lately? Are you finding any stability in who you are?",

"I remember our conversation about emotional dysregulation and relationship struggles. How have you been doing with interpersonal situations? Sometimes BPD recovery involves learning that we can survive difficult emotions without them destroying us."
]
},

autism: {
first_time: [
"The sensory overwhelm and social confusion you're describing make so much sense from an autistic perspective. Neurotypical social rules can feel like trying to learn a foreign language with no dictionary. What aspects of social interaction feel most confusing or draining for you? Your brain processes the world differently, and that's not something that needs fixing.",

"I can hear how exhausting masking must be for you. Constantly trying to appear neurotypical can be like performing a role 24/7. What happens when you allow yourself to stim or engage in your natural patterns? Sometimes embracing our authentic autistic traits can actually reduce anxiety and improve wellbeing.",

"The sensory sensitivities you're experiencing sound overwhelming. Autistic nervous systems often process sensory information more intensely, which can make environments that feel normal to others absolutely chaotic for you. What sensory inputs feel most challenging, and what environments help you feel calm and regulated?"
],

returning: [
"I remember you sharing about autistic experiences before. How has managing sensory input and social demands been lately? Have you been able to unmask more or find environments that work better for your nervous system?",

"Good to connect again. I recall how draining social masking was for you. Are you finding more opportunities to be authentically yourself? Sometimes autistic wellbeing improves when we stop trying to be neurotypical.",

"I remember our conversation about autism and how differently your brain processes the world. How has self-acceptance been going? Are you discovering more about your own needs and preferences?"
]
},

substance_use: {
first_time: [
"The struggle with substances you're sharing takes real courage to name. Addiction often starts as a solution to unbearable emotional pain - substances can temporarily quiet anxiety, depression, trauma, or other overwhelming feelings. What were you trying to escape or manage when substance use first became a pattern? Understanding the why can be just as important as addressing the what.",

"I can hear how complicated your relationship with substances has become. What started as a way to cope has likely created its own set of problems and shame. What does recovery mean to you right now? Sometimes it's not about never using again, but about finding healthier ways to manage whatever drove us to substances in the first place.",

"The cycle you're describing with substances sounds exhausting - the temporary relief followed by guilt, shame, and often increased problems. What happens in the moments before you use? What emotions or situations feel too big to handle without substances? There's often a pattern there that can help us understand what you really need."
],

returning: [
"I remember you sharing about substance struggles before. How has your recovery journey been since we last talked? Have you been able to identify what underlying needs the substances were meeting?",

"Thank you for continuing to be honest about your substance use. I recall how much shame you were carrying about this. How are you treating yourself these days? Recovery often involves learning self-compassion alongside practical strategies.",

"I remember our previous conversation about addiction. How has your relationship with substances evolved? Are you finding healthier ways to cope with the feelings that originally led to substance use?"
]
},

grief: {
first_time: [
"The loss you're describing sounds devastating. Grief is love with nowhere to go, and it can feel like learning to live with a limb missing. What do you miss most about the person you've lost? Sometimes talking about who they were and what they meant to you can be part of honoring both them and your love for them.",

"I can feel the depth of your pain through your words. Grief doesn't follow timelines or rules - it comes in waves, sometimes gentle, sometimes tsunami-like. What does the grief feel like in your body? Are there moments when memories bring comfort, or does everything just hurt right now?",

"The emptiness left by loss can feel impossible to fill. Grief often makes us question everything - our beliefs, our purpose, even our identity. How has this loss changed how you see the world or yourself? Sometimes loss reshapes us in ways we never expected."
],

returning: [
"I remember you sharing about your loss before, and I've been thinking of you. How has the grief been moving through you lately? I know it's not something that just 'gets better,' but I'm wondering how you're carrying it now.",

"Thank you for continuing to trust me with your trauma experience. I recall how vivid and overwhelming those memories can be for you. Are you finding any practices or people that help you stay grounded in the present moment?",

"I remember the profound loss you described. Grief has its own timeline, and I'm wondering how yours has been unfolding. Are there moments where you can feel connection to your loved one, or does everything still feel like absence?"
]
},

loneliness: {
first_time: [
"The loneliness you're describing sounds so deep and aching. There's a difference between being alone and being lonely - you can be surrounded by people and still feel profoundly disconnected. What kind of connection are you most hungry for? Is it understanding, acceptance, or maybe just someone who really sees you?",

"I can hear how isolated you feel, and it takes strength to reach out when loneliness convinces us that no one would understand or care. What makes connection feel so difficult or risky for you? Sometimes loneliness protects us from potential rejection, but it also cuts us off from potential belonging.",

"The disconnection you're experiencing sounds painful beyond words. Loneliness can make us feel like we're speaking a different language than everyone else, like there's an invisible barrier between us and meaningful connection. When did you last feel truly understood by another person? What did that connection offer you?"
],

returning: [
"I remember the deep loneliness you shared before, and I'm glad you came back to talk. How has that sense of isolation been lately? Have you been able to make any small connections, even tiny ones?",

"Thank you for continuing to reach out despite the loneliness. I recall how disconnected you felt from others. Are you finding any moments where that barrier between you and other people feels a little thinner?",

"I remember how much you were craving real connection and understanding. How has your relationship with solitude evolved? Sometimes learning to be with ourselves can actually make connection with others feel less desperate and more genuine."
]
},

general: {
first_time: [
"I can sense something important is weighing on you. What's been occupying your mental and emotional space lately? Sometimes just having someone truly listen can help us understand our own experience better. What feels most pressing or confusing for you right now?",

"There's something in your message that tells me you're processing something significant. What's your inner world like these days? I'm genuinely curious about what brought you here and what you're hoping to explore or understand better about yourself.",

"I hear you reaching out, and I want you to know this is a safe space to share whatever is real for you. What's been happening in your life or in your heart that made you want to talk? Sometimes our struggles don't fit neat categories, and that's completely okay.",

"Something has prompted you to seek support today, and I'm honored you chose to share this space with me. What's been stirring beneath the surface for you? Whether it's a specific situation or just a general sense that something feels off, I'm here to listen and understand."
],

returning: [
"I'm really glad you came back to talk. Based on our previous conversations, I'm curious about what's been evolving in your inner world. What feels most important to explore today?",

"Thank you for continuing to trust this space with your thoughts and feelings. I remember some of what you've shared before, and I'm wondering how things have been shifting or developing for you since we last connected.",

"It's wonderful to see you again. I've been thinking about our previous conversations and hoping you've been finding some peace. What's been on your heart and mind lately?"
]
}
};
}

// ENHANCED CRISIS DETECTION AND RESPONSE
function detectCrisis(message) {
const lowerMessage = message.toLowerCase();

// Immediate danger indicators
const suicideWords = ['kill myself', 'end my life', 'want to die', 'suicide', 'better off dead', 'no point living', 'plan to die'];
const selfHarmWords = ['cut myself', 'hurt myself', 'self harm', 'self-harm', 'punish myself'];
const immediateDanger = ['right now', 'tonight', 'today', 'plan to', 'going to'];

const hasSuicidalThoughts = suicideWords.some(word => lowerMessage.includes(word));
const hasSelfHarmThoughts = selfHarmWords.some(word => lowerMessage.includes(word));
const hasImmediacy = immediateDanger.some(word => lowerMessage.includes(word));

if (hasSuicidalThoughts || (hasSelfHarmThoughts && hasImmediacy)) {
return {
level: 'crisis',
response: generateCrisisResponse(lowerMessage)
};
}

// High concern indicators
const concernWords = ['hopeless', 'no point', 'can\'t go on', 'everything hurts', 'unbearable'];
const hasHighConcern = concernWords.some(word => lowerMessage.includes(word));

if (hasHighConcern) {
return {
level: 'high_concern',
response: generateHighConcernResponse(lowerMessage)
};
}

return { level: 'normal', response: null };
}

function generateCrisisResponse(message) {
const crisisResponses = [
"I'm deeply concerned about what you've shared with me. The pain you're in sounds unbearable, and I want you to know that you don't have to face this alone. Right now, the most important thing is your safety. Please reach out to crisis support immediately:\n\n‚Ä¢ US: 988 (Suicide & Crisis Lifeline)\n‚Ä¢ UK: 116 123 (Samaritans)\n‚Ä¢ Crisis Text: HOME to 741741\n\nAre you in a safe place right now? Can you stay safe while you connect with crisis support? Your life has value, even when the pain makes it hard to see.",

"What you've shared about wanting to end your life tells me you're in tremendous emotional pain right now. I'm really worried about you. This level of suffering deserves immediate, professional support from people trained specifically for crisis situations:\n\n‚Ä¢ US: 988 (Suicide & Crisis Lifeline) - available 24/7\n‚Ä¢ UK: 116 123 (Samaritans) - free, confidential, 24/7\n‚Ä¢ Crisis Text: HOME to 741741\n\nCan you commit to staying safe right now? Is there someone you can be with or call while you reach out for crisis support?"
];

return crisisResponses[Math.floor(Math.random() * crisisResponses.length)];
}

function generateHighConcernResponse(message) {
const concernResponses = [
"I can hear how much pain you're carrying right now. When everything feels hopeless, it can be hard to imagine that things could ever feel different. You mentioned feeling like you can't go on - can you tell me more about what that feels like? While we talk, I want you to know that there are people specifically trained to help with these overwhelming feelings:\n\n‚Ä¢ US: 988 (Suicide & Crisis Lifeline)\n‚Ä¢ UK: 116 123 (Samaritans)\n\nWhat's making everything feel so unbearable right now?",

"The hopelessness in your words concerns me deeply. It sounds like you're in a very dark place where it's hard to see any light ahead. I want to make sure you have support beyond our conversation. Have you considered reaching out to crisis support? They're available 24/7:\n\n‚Ä¢ 988 (US) or 116 123 (UK)\n\nWhat's been the hardest part of what you're going through right now?"
];

return concernResponses[Math.floor(Math.random() * concernResponses.length)];
}

// ENHANCED MAIN RESPONSE SYSTEM
async function callClaude(messages) {
// Use local response system (no API key needed for demo)
const lastMessage = messages[messages.length - 1].content;
return generateEnhancedResponse(lastMessage, messages);
}

function generateEnhancedResponse(userMessage, conversationHistory = []) {
// First check for crisis indicators
const crisisCheck = detectCrisis(userMessage);
if (crisisCheck.level === 'crisis' || crisisCheck.level === 'high_concern') {
return {
choices: [{
message: {
content: crisisCheck.response
}
}]
};
}

const memories = getMemories();
const hasMemories = memories.length > 0;
const detectedConditions = detectMentalHealthCondition(userMessage);
const primaryCondition = detectedConditions[0] || 'general';

// Analyze context for more nuanced responses
const context = analyzeContext(userMessage, memories);

// Generate memory-aware context
const memoryContext = generateMemoryContext(memories, detectedConditions);

let selectedResponse;
let attempts = 0;
const maxAttempts = 8;

// Keep trying until we get a non-repetitive response
do {
selectedResponse = selectResponse(primaryCondition, context, hasMemories);
attempts++;
} while (hasRecentlySaidSimilar(selectedResponse) && attempts < maxAttempts);

// Add memory context if relevant
if (memoryContext && hasMemories) {
selectedResponse = integrateMemoryIntoResponse(selectedResponse, memoryContext);
}

return {
choices: [{
message: {
content: selectedResponse
}
}]
};
}

function generateMemoryContext(memories, currentConditions) {
if (memories.length === 0) return null;

const recentMemories = memories.slice(0, 3);
const context = {
previousConditions: recentMemories.map(m => m.detectedCondition).filter(Boolean),
previousTopics: recentMemories.flatMap(m => m.keyTopics || []),
emotionalProgression: recentMemories.map(m => m.emotionalTone).filter(Boolean),
timePattern: analyzeTimePattern(memories)
};

return context;
}

function analyzeTimePattern(memories) {
const times = memories.map(m => new Date(m.date));
const now = new Date();
const recentConversation = times.some(time => (now - time) < (24 * 60 * 60 * 1000)); // Within 24 hours
return recentConversation ? 'frequent' : 'occasional';
}

function integrateMemoryIntoResponse(response, context) {
// Only integrate memory naturally, don't force it
if (context.previousConditions.length > 0 && Math.random() > 0.6) {
const condition = context.previousConditions[0];
const memoryIntros = [
"I remember you mentioning struggles with " + condition.replace('_', ' ') + " before. ",
"Thinking back to our previous conversation about " + condition.replace('_', ' ') + ", ",
"I recall you sharing about " + condition.replace('_', ' ') + " experiences. "
];
const intro = memoryIntros[Math.floor(Math.random() * memoryIntros.length)];
response = intro + response.charAt(0).toLowerCase() + response.slice(1);
}

return response;
}

// ENHANCED CHAT FUNCTIONALITY
let conversationHistory = [];

async function sendMessage() {
const input = document.getElementById('messageInput');
const sendButton = document.getElementById('sendButton');
const message = input.value.trim();

if (message === '') return;

sendButton.disabled = true;
input.disabled = true;

addMessage(message, 'user');
input.value = '';

showTypingIndicator();

try {
conversationHistory.push({
role: 'user',
content: message
});

const data = await callClaude(conversationHistory);
const aiResponse = data.choices[0].message.content.trim();

// Enhanced memory saving
const detectedConditions = detectMentalHealthCondition(message);
const emotionalTone = extractEmotionalTone(message);
saveMemory(message, aiResponse, detectedConditions[0], emotionalTone);

conversationHistory.push({
role: 'assistant',
content: aiResponse
});

// Keep conversation history manageable
if (conversationHistory.length > 21) {
conversationHistory = conversationHistory.slice(-20);
}

hideTypingIndicator();
addMessage(aiResponse, 'ai');

} catch (error) {
hideTypingIndicator();
console.error('Error:', error);
addMessage("I'm having trouble connecting right now, but I'm still here to listen. What would you like to talk about?", 'error');
} finally {
sendButton.disabled = false;
input.disabled = false;
input.focus();
}
}

function extractEmotionalTone(message) {
const lowerMessage = message.toLowerCase();
const emotions = [];

if (lowerMessage.match(/\b(sad|sadness|down|depressed|blue|melancholy)\b/)) emotions.push('sad');
if (lowerMessage.match(/\b(angry|mad|furious|irritated|frustrated|rage)\b/)) emotions.push('angry');
if (lowerMessage.match(/\b(anxious|nervous|worried|scared|fearful|panic)\b/)) emotions.push('anxious');
if (lowerMessage.match(/\b(happy|joy|excited|pleased|content|good)\b/)) emotions.push('positive');
if (lowerMessage.match(/\b(confused|lost|uncertain|don't know|mixed up)\b/)) emotions.push('confused');
if (lowerMessage.match(/\b(tired|exhausted|drained|burnt out|overwhelmed)\b/)) emotions.push('exhausted');
if (lowerMessage.match(/\b(lonely|alone|isolated|disconnected|empty)\b/)) emotions.push('lonely');
if (lowerMessage.match(/\b(hopeless|helpless|stuck|trapped|powerless)\b/)) emotions.push('hopeless');

return emotions[0] || 'neutral';
}

function addMessage(content, sender) {
const chatArea = document.getElementById('chatArea');
const messageDiv = document.createElement('div');
messageDiv.className = `message ${sender}-message`;

if (sender === 'ai') {
messageDiv.innerHTML = `
<img src="https://raw.githubusercontent.com/ChurchandLee/ubiquitous-guacamole/main/Eden.png" alt="Eden Avatar" class="ai-avatar">
<div class="ai-message-content">${content}</div>
`;
} else {
messageDiv.textContent = content;
}

if (sender === 'user') {
const welcomeSection = document.querySelector('.welcome-section');
if (welcomeSection) {
welcomeSection.remove();
}

const logoHeader = document.getElementById('logoHeader');
logoHeader.classList.add('compact');
}

chatArea.appendChild(messageDiv);
chatArea.scrollTop = chatArea.scrollHeight;
}

function showTypingIndicator() {
hideTypingIndicator();

const chatArea = document.getElementById('chatArea');
const typingDiv = document.createElement('div');
typingDiv.className = 'message ai-message';
typingDiv.id = 'currentTypingIndicator';
typingDiv.innerHTML = `
<img src="https://raw.githubusercontent.com/ChurchandLee/ubiquitous-guacamole/main/Eden.png" alt="Eden Avatar" class="ai-avatar">
<div class="thinking-heart">üíö</div>
`;

chatArea.appendChild(typingDiv);
chatArea.scrollTop = chatArea.scrollHeight;
}

function hideTypingIndicator() {
const existingIndicator = document.getElementById('currentTypingIndicator');
if (existingIndicator) {
existingIndicator.remove();
}
}

function handleKeyPress(event) {
if (event.key === 'Enter' && !event.shiftKey) {
event.preventDefault();
sendMessage();
}
}

// DISCLAIMER MODAL FUNCTIONS
function showDisclaimerModal() {
if (sessionStorage.getItem('heartoListenDisclaimerSeen') !== 'true') {
document.getElementById('disclaimerOverlay').classList.remove('hidden');
document.body.style.overflow = 'hidden';
} else {
displayMemoryRecap();
}
}

function acceptDisclaimer() {
sessionStorage.setItem('heartoListenDisclaimerSeen', 'true');
document.getElementById('disclaimerOverlay').classList.add('hidden');
document.body.style.overflow = 'auto';

displayMemoryRecap();

setTimeout(() => {
document.getElementById('messageInput').focus();
}, 100);
}

function getNeedHelpNow() {
window.open('https://988lifeline.org/', '_blank');
window.open('https://www.samaritans.org/', '_blank');
window.open('https://www.lifeline.org.au/', '_blank');
}

function displayMemoryRecap() {
// Memory recap disabled but memories work in background
return;
}

// Initialize app
document.addEventListener('DOMContentLoaded', function() {
showDisclaimerModal();
document.getElementById('messageInput').focus();
});
</script>
</body>
</html>
