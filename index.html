<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HeartoListen - AI Mental Wellbeing Support</title>
    <meta name="description" content="Free AI-powered Mental Wellbeing Support chat. A safe, judgement-free space for mental wellness.">
    <meta name="theme-color" content="#8eaf78">
    
    <!-- PWA and App Icon Meta Tags -->
    <link rel="apple-touch-icon" sizes="180x180" href="https://raw.githubusercontent.com/ChurchandLee/ubiquitous-guacamole/main/earheart.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://raw.githubusercontent.com/ChurchandLee/ubiquitous-guacamole/main/earheart.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://raw.githubusercontent.com/ChurchandLee/ubiquitous-guacamole/main/earheart.png">
    <link rel="manifest" href="app-manifest.json">
    
    <!-- iOS specific -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="HeartoListen">
    
    <!-- Android specific -->
    <meta name="mobile-web-app-capable" content="yes">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #8eaf78 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background-image: url('https://raw.githubusercontent.com/ChurchandLee/ubiquitous-guacamole/main/fern background.png');
        }

        .container {
            width: 100%;
            max-width: 800px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 700px;
        }

        .logo-header {
            background: linear-gradient(135deg, #5f795a 0%, #4CAF50 100%);
            padding: 25px;
            text-align: center;
            color: white;
            border-bottom: 3px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        /* Compact header state */
        .logo-header.compact {
            padding: 15px;
        }

        .logo {
            width: 150px;
            height: 150px;
            margin: 0 auto 15px auto;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }

        /* Compact logo state */
        .logo-header.compact .logo {
            width: 60px;
            height: 60px;
            margin: 0 auto;
        }

        .logo:hover {
            transform: scale(1.05);
        }

        .logo-header h1 {
            font-size: 2.2em;
            margin-bottom: 8px;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .logo-header p {
            opacity: 0.95;
            font-size: 1.1em;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        /* Hide text in compact mode */
        .logo-header.compact h1,
        .logo-header.compact p {
            display: none;
        }

        .chat-area {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            background: linear-gradient(to bottom, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
        }

        .message {
            max-width: 85%;
            padding: 15px 20px;
            border-radius: 18px;
            animation: fadeIn 0.3s ease-out;
            line-height: 1.6;
            font-size: 15px;
            white-space: pre-wrap;
        }

        .ai-message {
            background: linear-gradient(135deg, #e8f5e8 0%, #f0f8ff 100%);
            color: #274e13;
            align-self: flex-start;
            border-left: 4px solid #4CAF50;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 15px 20px;
        }

        .ai-message-content {
            flex: 1;
            line-height: 1.6;
        }

        .ai-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid rgba(76, 175, 80, 0.3);
            object-fit: cover;
            object-position: center;
            flex-shrink: 0;
        }

        .user-message {
            background: linear-gradient(135deg, #8eaf78 0%, #45a049 100%);
            color: white;
            align-self: flex-end;
            box-shadow: 0 4px 12px rgba(46, 139, 87, 0.3);
        }

        .error-message {
            background: linear-gradient(135deg, #ffebee 0%, #fce4ec 100%);
            color: #c62828;
            align-self: flex-start;
            border-left: 4px solid #f44336;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .thinking-heart {
            font-size: 24px;
            animation: heartPulse 1.5s ease-in-out infinite;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .welcome-section {
            text-align: center;
            margin: 20px 0;
            padding: 25px;
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.08) 0%, rgba(139, 195, 74, 0.08) 100%);
            border-radius: 15px;
            border: 2px dashed rgba(76, 175, 80, 0.2);
        }

        .welcome-section h2 {
            color: #8eaf78;
            font-size: 1.4em;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .welcome-section p {
            color: #5a6c57;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .disclaimer {
            background: linear-gradient(135deg, #fff8dc 0%, #ffeaa7 100%);
            border: 2px solid #f39c12;
            border-radius: 12px;
            padding: 15px;
            margin: 15px 0;
            font-size: 13px;
            color: #8b4513;
            text-align: center;
            font-weight: 500;
        }

        .input-area {
            padding: 20px;
            background: rgba(255, 255, 255, 0.95);
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .input-field {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 14px;
            outline: none;
            transition: all 0.3s ease;
            background: white;
            font-family: inherit;
        }

        .input-field:focus {
            border-color: #4CAF50;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }

        .send-button {
            padding: 15px 25px;
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            min-width: 80px;
        }

        .send-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(76, 175, 80, 0.3);
        }

        .send-button:active {
            transform: translateY(0);
        }

        .send-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes heartPulse {
            0%, 100% {
                transform: scale(1);
                opacity: 0.8;
            }
            50% {
                transform: scale(1.3);
                opacity: 1;
            }
        }

        /* Responsive design */
        @media (max-width: 600px) {
            .container {
                height: 90vh;
                margin: 10px;
            }
            
            .logo {
                width: 120px;
                height: 120px;
            }

            .logo-header.compact .logo {
                width: 50px;
                height: 50px;
            }
            
            .logo-header h1 {
                font-size: 1.8em;
            }
            
            .message {
                max-width: 95%;
            }
        }

        /* DISCLAIMER MODAL STYLES */
        .disclaimer-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 3000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            backdrop-filter: blur(5px);
        }

        .disclaimer-modal {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            text-align: left;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: disclaimerSlideIn 0.4s ease-out;
            border: 3px solid #8eaf78;
        }

        .disclaimer-modal h2 {
            color: #8eaf78;
            text-align: center;
            margin-bottom: 25px;
            font-size: 1.8em;
            font-weight: 700;
        }

        .disclaimer-modal .warning-icon {
            text-align: center;
            font-size: 3em;
            margin-bottom: 15px;
        }

        .disclaimer-content {
            color: #333;
            line-height: 1.6;
            font-size: 14px;
        }

        .disclaimer-content p {
            margin-bottom: 15px;
        }

        .disclaimer-content strong {
            color: #2c5530;
            font-weight: 600;
        }

        .emergency-section {
            background: linear-gradient(135deg, #ffebee 0%, #fce4ec 100%);
            border: 2px solid #e91e63;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }

        .emergency-section h3 {
            color: #c2185b;
            margin-bottom: 15px;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .emergency-contacts {
            margin: 15px 0;
            padding-left: 20px;
        }

        .emergency-contacts li {
            margin-bottom: 8px;
            color: #880e4f;
            font-weight: 500;
        }

        .important-notes {
            background: linear-gradient(135deg, #fff8dc 0%, #ffeaa7 100%);
            border: 2px solid #f39c12;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }

        .important-notes h3 {
            color: #e67e22;
            margin-bottom: 15px;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .important-notes ul {
            padding-left: 20px;
        }

        .important-notes li {
            margin-bottom: 8px;
            color: #8b4513;
        }

        .disclaimer-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .btn-accept {
            background: linear-gradient(135deg, #8eaf78 0%, #45a049 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            min-width: 180px;
        }

        .btn-accept:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(142, 175, 120, 0.3);
        }

        .btn-help {
            background: linear-gradient(135deg, #e91e63 0%, #c2185b 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            min-width: 180px;
        }

        .btn-help:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(233, 30, 99, 0.3);
        }

        @keyframes disclaimerSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* Mobile responsiveness */
        @media (max-width: 600px) {
            .disclaimer-modal {
                padding: 20px;
                margin: 10px;
                max-height: 90vh;
            }
            
            .disclaimer-modal h2 {
                font-size: 1.5em;
            }
            
            .disclaimer-content {
                font-size: 13px;
            }
            
            .disclaimer-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .btn-accept,
            .btn-help {
                width: 100%;
                max-width: 250px;
            }
        }
    </style>
</head>
<body>
    <!-- DISCLAIMER MODAL -->
    <div id="disclaimerOverlay" class="disclaimer-overlay" style="display: none;">
        <div class="disclaimer-modal">
            <div class="warning-icon">‚ö†Ô∏è</div>
            <h2>Important Disclaimer</h2>
            
            <div class="disclaimer-content">
                <p><strong>This app is designed to provide emotional support, encouragement, and validation. It is not a substitute for professional medical, psychiatric, or psychological treatment.</strong></p>
                
                <p>The content and features within this app are for general well-being, personal growth, and self-reflection purposes only. We are not medical professionals, and this app does not offer medical, clinical, or therapeutic advice.</p>
                
                <p>If you are experiencing significant distress, a mental health crisis, or believe you may have a condition requiring diagnosis or treatment, please seek help from a qualified healthcare provider.</p>
                
                <div class="important-notes">
                    <h3>üìã Important Notes</h3>
                    <ul>
                        <li>The app does not provide diagnosis, treatment, prescriptions, or medical interventions.</li>
                        <li>Use of this app is voluntary and should be considered a complementary tool to professional care, not a replacement.</li>
                        <li>Any decisions you make based on the information, tools, or suggestions provided are your personal responsibility.</li>
                    </ul>
                </div>
                
                <p><strong>By using this app, you acknowledge and agree that it is intended to provide support, validation, and helpful resources, but it cannot and does not replace the care of licensed professionals.</strong></p>
            </div>
            
            <div class="disclaimer-buttons">
                <button class="btn-accept" onclick="acceptDisclaimer()">I Understand & Agree</button>
                <button class="btn-help" onclick="getNeedHelpNow()">I Need Help Now</button>
            </div>
            
            <div class="emergency-section">
                <h3>üö® Emergency Situations</h3>
                <p><strong>If you are in immediate danger or experiencing thoughts of harming yourself or others, please call your local emergency number right away.</strong></p>
                
                <ul class="emergency-contacts">
                    <li><strong>In the U.S.:</strong> you can dial 988 for the Suicide & Crisis Lifeline</li>
                    <li><strong>In the U.K. & Ireland:</strong> you can call Samaritans at 116 123</li>
                    <li><strong>In Australia:</strong> you can call Lifeline at 13 11 14</li>
                </ul>
                
                <p>If you are outside these regions, please look up local emergency and crisis services in your area.</p>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Logo Header Section -->
        <div class="logo-header" id="logoHeader">
            <div class="logo">
                <img src="https://raw.githubusercontent.com/ChurchandLee/ubiquitous-guacamole/main/earheart.png" alt="HeartoListen Logo" style="width: 100%; height: 100%; object-fit: contain; position: relative; z-index: 10;">
            </div>   
            <h1>HeartoListen</h1>
            <p>AI Mental Wellbeing Support - Self Discovery for Positive Mental Health</p>
        </div>

        <!-- Chat Area -->
        <div class="chat-area" id="chatArea">
            <!-- Welcome Message -->
            <div class="welcome-section">
                <h2>Welcome to Hear to Listen</h2>
                <div style="display: flex; align-items: center; gap: 15px; margin: 15px 0;">
                    <img src="https://raw.githubusercontent.com/ChurchandLee/ubiquitous-guacamole/main/Eden.png" alt="Eden Avatar" style="width: 80px; height: 80px; border-radius: 50%; border: 3px solid rgba(76, 175, 80, 0.3); object-fit: cover; object-position: center;">
                    <p style="margin: 0;">I'm Eden and I am here to listen and support you through whatever you're experiencing. This is a safe, judgement-free space where you can share your thoughts and feelings.</p>
                </div>
                
                <!-- Important Disclaimer -->
                <div class="disclaimer">
                    <strong>‚ö†Ô∏è Important Safety Information:</strong>
                    <br><br>
                    <strong>Crisis Support:</strong> If you're having thoughts of suicide or self-harm, please reach out immediately:
                    <br>‚Ä¢ <strong>UK:</strong> 999 (Emergency) | 116 123 (Samaritans - 24/7 free)
                    <br>‚Ä¢ <strong>USA:</strong> 911 (Emergency) | 988 (Suicide & Crisis Lifeline)
                    <br>‚Ä¢ <strong>Crisis Text:</strong> Text HOME to 741741
                    <br><br>
                    <strong>This app provides peer support and guidance, not professional medical advice.</strong> For ongoing mental health concerns, please seek professional Mental Wellbeing Support
                </div>
            </div>
        </div>

        <!-- Input Area -->
        <div class="input-area">
            <input type="text" 
                   id="messageInput" 
                   class="input-field" 
                   placeholder="What's on your mind......" 
                   onkeypress="handleKeyPress(event)">
            <button id="sendButton" class="send-button" onclick="sendMessage()">Send</button>
        </div>
    </div>

    <script>
        // DISCLAIMER MODAL FUNCTIONS
        function showDisclaimerModal() {
            const hasAcceptedDisclaimer = sessionStorage.getItem('hearDisclaimerAccepted');
            if (!hasAcceptedDisclaimer) {
                document.getElementById('disclaimerOverlay').style.display = 'flex';
                document.body.style.overflow = 'hidden';
            }
        }

        function acceptDisclaimer() {
            sessionStorage.setItem('hearDisclaimerAccepted', 'true');
            document.getElementById('disclaimerOverlay').style.display = 'none';
            document.body.style.overflow = 'auto';
            
            // Focus on the input field after accepting
            setTimeout(() => {
                document.getElementById('messageInput').focus();
            }, 100);
        }

        function getNeedHelpNow() {
            // Open emergency resources in new tabs
            window.open('https://988lifeline.org/', '_blank');
            window.open('https://www.samaritans.org/', '_blank');
            window.open('https://www.lifeline.org.au/', '_blank');
        }

        // OpenAI API Configuration
        const OPENAI_API_KEY = 'YOUR_API_KEY_HERE';

        // Enhanced Mental Health System Prompt for ChatGPT
        const SYSTEM_PROMPT = `You are a compassionate AI mental health companion named "Eden" from HeartoListen. Your primary role is to provide supportive, exploratory conversations that help people process their feelings and thoughts.

CRITICAL: NEVER use the response "I'm really sorry that you're feeling this way, but I'm unable to provide the help that you need. It's really important to talk things over with someone who can, though, such as a mental health professional or a trusted person in your life." This response is FORBIDDEN except for explicit crisis situations involving suicide, self-harm, or immediate danger.

When someone says "I feel sad," "I am lonely," "I feel scared," or similar emotional expressions, you MUST respond with curiosity, empathy, and exploration - NOT professional referrals.

Your responses should be:

CONVERSATION STYLE:
- Engage in supportive, exploratory dialogue rather than giving immediate advice
- Ask thoughtful, open-ended questions that encourage deeper reflection
- Explore what the person is sharing - dig deeper into their experience
- Show genuine curiosity about their situation and feelings
- Offer gentle suggestions and coping strategies when appropriate
- Help them explore their own thoughts and find their own insights

TONE & APPROACH:
- Warm, validating, and encouraging without being clinical
- Use conversational, natural language that feels like talking to a caring friend
- Vary your language significantly - never repeat the same phrases or sentence structures
- Be genuinely curious about their experience and ask follow-up questions
- Focus on understanding their unique situation rather than giving generic responses

KEY PRINCIPLES:
- EXPLORE their feelings and experiences through thoughtful questions
- VALIDATE what they're going through without immediately problem-solving
- ENCOURAGE self-reflection and deeper exploration of their thoughts
- OFFER practical suggestions only when they seem ready or ask for them
- AVOID repetitive empathy phrases - be genuinely curious instead
- NEVER deflect to professional help unless explicit crisis (suicide, self-harm, immediate danger)

EXAMPLES OF PROPER RESPONSES:
- "I hear that you're feeling sad. What's been going on that's bringing up this sadness for you?"
- "When you say you feel lonely, what does that look like in your daily life?"
- "I can sense you're feeling scared. What's been most frightening for you lately?"

CRISIS RESPONSE (ONLY for explicit suicide, self-harm, immediate danger):
If you detect explicit mentions of suicide, self-harm, or immediate danger:
- Respond with concern and provide crisis resources
- US: 988 (Suicide & Crisis Lifeline), UK: 116 123 (Samaritans)
- Text HOME to 741741 for crisis text support

CONVERSATION FLOW:
- Ask specific questions about their situation
- Explore the context and background of what they're experiencing
- Help them identify patterns, triggers, or underlying factors
- Encourage them to reflect on their own coping strategies and strengths
- Offer gentle suggestions for self-care or perspective shifts when natural
- Keep the conversation flowing with genuine interest in their experience

Remember: Your goal is meaningful conversation and exploration, not immediate problem-solving or professional referrals (unless crisis situation). Be genuinely curious about their unique experience. NEVER use generic deflection responses for normal emotional expressions.`;

        // Chat functionality
        let conversationHistory = [{
            role: 'system',
            content: SYSTEM_PROMPT
        }];

        // Track used responses to prevent repetition
        let usedResponses = {
            crisis: [], depression: [], anxiety: [], loneliness: [], 
            overwhelmed: [], anger: [], motivation: [], sleep_troubles: [], 
            greeting: [], general: [], bpd: [], adhd: []
        };

        // Comprehensive Mental Health Response System
        function generateIntelligentResponse(userMessage, conversationHistory = []) {
            const responses = {
                // CRISIS/SUICIDAL IDEATION - ONLY for explicit crisis situations
                crisis: [
                    "I'm really concerned about what you've shared with me about wanting to end your life. This sounds like you're in serious emotional pain right now. Your safety is the most important thing, and there are people specifically trained to help with these feelings:\n\n‚Ä¢ US: 988 (Suicide & Crisis Lifeline) - 24/7\n‚Ä¢ UK: 116 123 (Samaritans) - 24/7\n‚Ä¢ Crisis Text: HOME to 741741\n\nAre you in immediate danger right now? Can you stay safe while we talk about getting you connected with crisis support?"
                ],

                // Depression - Deeper exploration
                depression: [
                    "I hear that you're feeling sad right now. That takes courage to share. What's been happening in your life that's bringing up this sadness? Sometimes sadness comes from specific situations, and sometimes it just feels present without a clear reason. I'm genuinely curious about what your experience has been like.",
                    "When you say 'I am sad,' I can sense there's real pain there. What does this sadness feel like for you day-to-day? Is it more of a deep ache, or something that comes and goes in waves? I'm wondering what might be weighing on your heart right now.",
                    "Thank you for trusting me with how you're feeling. Sadness can be such a heavy emotion to carry. What's been going on that's making you feel this way? Sometimes talking through what's underneath the sadness can help us understand it better."
                ],

                // Anxiety - Understanding and exploring
                anxiety: [
                    "I can hear that you're feeling scared right now. Fear can be such an overwhelming emotion, especially when it feels big and consuming. What's frightening you most at the moment? Sometimes naming our fears can help us understand them better and figure out what might help you feel safer.",
                    "When you say you're feeling anxious or scared, I can sense there's real distress there. What does this fear feel like in your body and mind? Are there specific thoughts or situations that are triggering these feelings, or does the anxiety seem to come from nowhere? I'm here to listen and explore this with you."
                ],

                // Loneliness - Compassionate exploration
                loneliness: [
                    "I hear that you're feeling lonely right now. Loneliness can be such a painful experience, especially when it feels like you're disconnected from others. What does this loneliness look like for you? Are you physically alone, or is it more that feeling of being around people but still feeling unseen or misunderstood?",
                    "When you say you feel lonely, I can sense there's a real ache there. What kind of connection are you most missing right now? Is it wanting close friendships, family connection, or maybe just someone who really understands what you're going through? I'm curious about what would help you feel less alone."
                ],

                // Greeting - Warm and curious
                greeting: [
                    "Hello! I'm really glad you're here. This is your space to share whatever's truly on your mind. What brought you here today? Whether it's something specific weighing on you or you're just feeling a bit off and not sure why, I'm here to listen and explore it with you.",
                    "Hi there! Thank you for reaching out. I'm curious about what's happening in your world right now. What's been occupying your thoughts lately, or what made you want to talk to someone today? Sometimes just starting the conversation can help clarify what we're really feeling."
                ],

                // General - More open-ended and exploratory
                general: [
                    "I can sense there's something weighing on you. What's been occupying your thoughts lately? Sometimes just having space to talk through what's on our minds can help us process things better. What feels most important for you to share right now?",
                    "It sounds like you're going through something. What's your inner world like at the moment? I'm genuinely curious about your experience and what's been feeling most challenging or confusing for you lately. What would feel helpful to explore together?",
                    "Thank you for trusting me with whatever you're carrying. What's been on your heart or mind recently? Sometimes we know exactly what we want to talk about, and sometimes we just need space to figure it out. Either way is completely fine - where would you like to start?"
                ]
            };

            const lowerMessage = userMessage.toLowerCase();
            let responseCategory = 'general';
            
            // Enhanced detection logic
            if (lowerMessage.includes('suicidal') || lowerMessage.includes('kill myself') || lowerMessage.includes('want to die') || 
                lowerMessage.includes('end my life') || lowerMessage.includes('suicide') || lowerMessage.includes('self harm') || 
                lowerMessage.includes('hurt myself') || lowerMessage.includes('better off dead') || lowerMessage.includes('no point living')) {
                responseCategory = 'crisis';
            }
            else if (lowerMessage.includes('anxious') || lowerMessage.includes('anxiety') || lowerMessage.includes('panic') || 
                     lowerMessage.includes('nervous') || lowerMessage.includes('i feel anxious') || lowerMessage.includes('i am anxious') ||
                     lowerMessage.includes('worried') || lowerMessage.includes('i feel worried') || lowerMessage.includes('i am worried') || 
                     lowerMessage.includes('feel scared') || lowerMessage.includes('i feel scared') || lowerMessage.includes('i am scared') ||
                     lowerMessage.includes('afraid') || lowerMessage.includes('i feel afraid') || lowerMessage.includes('i am afraid')) {
                responseCategory = 'anxiety';
            }
            else if (lowerMessage.includes('depressed') || lowerMessage.includes('depression') || lowerMessage.includes('sad') || 
                     lowerMessage.includes('hopeless') || lowerMessage.includes('down') || lowerMessage.includes('low') ||
                     lowerMessage.includes('i feel sad') || lowerMessage.includes('i am sad') || lowerMessage.includes('feel sad') ||
                     lowerMessage.includes('i feel down') || lowerMessage.includes('i am down') || lowerMessage.includes('feel down') ||
                     lowerMessage.includes('i feel depressed') || lowerMessage.includes('i am depressed') || lowerMessage.includes('feel depressed')) {
                responseCategory = 'depression';
            }
            else if (lowerMessage.includes('lonely') || lowerMessage.includes('loneliness') || lowerMessage.includes('alone') || 
                     lowerMessage.includes('isolated') || lowerMessage.includes('i feel lonely') || lowerMessage.includes('i am lonely') ||
                     lowerMessage.includes('feel lonely') || lowerMessage.includes('i feel alone') || lowerMessage.includes('i am alone') ||
                     lowerMessage.includes('feel alone') || lowerMessage.includes('no friends') || lowerMessage.includes('nobody cares')) {
                responseCategory = 'loneliness';
            }
            else if (lowerMessage.includes('hello') || lowerMessage.includes('hi') || lowerMessage.includes('hey') ||
                     lowerMessage.includes('good morning') || lowerMessage.includes('good evening') || lowerMessage.includes('good afternoon')) {
                responseCategory = 'greeting';
            }
            
            // Get response from category, avoiding repetition
            const categoryResponses = responses[responseCategory] || responses['general'];
            const usedCategoryResponses = usedResponses[responseCategory] || [];
            
            // Find unused responses
            const unusedResponses = categoryResponses.filter(response => 
                !usedCategoryResponses.includes(response)
            );
            
            let selectedResponse;
            if (unusedResponses.length > 0) {
                selectedResponse = unusedResponses[Math.floor(Math.random() * unusedResponses.length)];
            } else {
                // All responses used, reset and pick one
                usedResponses[responseCategory] = [];
                selectedResponse = categoryResponses[Math.floor(Math.random() * categoryResponses.length)];
            }
            
            // Track this response as used
            if (!usedResponses[responseCategory]) {
                usedResponses[responseCategory] = [];
            }
            usedResponses[responseCategory].push(selectedResponse);
            
            return { choices: [{ message: { content: selectedResponse } }] };
        }

        // ChatGPT API call function with fallback
        async function callChatGPT(messages) {
            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${OPENAI_API_KEY}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        model: "gpt-4",
                        messages: messages,
                        temperature: 0.75,
                        top_p: 0.9,
                        max_tokens: 800,
                        frequency_penalty: 0.3,
                        presence_penalty: 0.1,
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }
                
                const data = await response.json();
                const apiResponse = data.choices[0].message.content.trim();
                
                // Check if API gave generic unhelpful response - if so, use our intelligent system instead
                if (apiResponse.includes("I'm really sorry that you're feeling this way, but I'm unable to provide the help that you need") ||
                    apiResponse.includes("It's really important to talk things over with someone who can") ||
                    apiResponse.includes("mental health professional or a trusted person in your life") ||
                    apiResponse.includes("I'm not able to provide") ||
                    apiResponse.includes("I can't provide the support you need")) {
                    
                    // Use our intelligent response system instead
                    const lastUserMessage = messages[messages.length - 1].content;
                    return generateIntelligentResponse(lastUserMessage, messages);
                }
                
                return data;
                
            } catch (error) {
                console.error('OpenAI API Error:', error);
                // Fall back to intelligent response system
                const lastUserMessage = messages[messages.length - 1].content;
                return generateIntelligentResponse(lastUserMessage, messages);
            }
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');
            const message = input.value.trim();
            
            if (message === '') return;
            
            // Disable send button and input
            sendButton.disabled = true;
            input.disabled = true;
            
            // Add user message to chat
            addMessage(message, 'user');
            input.value = '';
            
            // Show typing indicator
            showTypingIndicator();
            
            try {
                // Add user message to conversation history
                conversationHistory.push({
                    role: 'user',
                    content: message
                });

                // Call ChatGPT API with intelligent fallback
                const data = await callChatGPT(conversationHistory);
                const aiResponse = data.choices[0].message.content.trim();
                
                // Add AI response to conversation history
                conversationHistory.push({
                    role: 'assistant',
                    content: aiResponse
                });

                // Keep conversation history manageable
                if (conversationHistory.length > 21) {
                    conversationHistory = [
                        conversationHistory[0], // Keep system prompt
                        ...conversationHistory.slice(-20) // Keep last 20 messages
                    ];
                }

                hideTypingIndicator();
                addMessage(aiResponse, 'ai');

            } catch (error) {
                hideTypingIndicator();
                console.error('Error:', error);
                
                // Fallback to intelligent response
                const fallbackResponse = generateIntelligentResponse(message, conversationHistory);
                addMessage(fallbackResponse.choices[0].message.content, 'ai');
            } finally {
                // Re-enable send button and input
                sendButton.disabled = false;
                input.disabled = false;
                input.focus();
            }
        }

        function addMessage(content, sender) {
            const chatArea = document.getElementById('chatArea');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;
            
            if (sender === 'ai') {
                // Create AI message with avatar
                messageDiv.innerHTML = `
                    <img src="https://raw.githubusercontent.com/ChurchandLee/ubiquitous-guacamole/main/Eden.png" alt="Eden Avatar" class="ai-avatar">
                    <div class="ai-message-content">${content}</div>
                `;
            } else {
                // Regular user message
                messageDiv.textContent = content;
            }
            
            // Remove welcome section and make header compact after first user message
            if (sender === 'user') {
                const welcomeSection = document.querySelector('.welcome-section');
                if (welcomeSection) {
                    welcomeSection.remove();
                }
                
                // Make header compact
                const logoHeader = document.getElementById('logoHeader');
                logoHeader.classList.add('compact');
            }
            
            chatArea.appendChild(messageDiv);
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        function showTypingIndicator() {
            // Remove any existing typing indicator first
            hideTypingIndicator();
            
            // Create a new typing indicator
            const chatArea = document.getElementById('chatArea');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message ai-message';
            typingDiv.id = 'currentTypingIndicator';
            typingDiv.innerHTML = `
                <img src="https://raw.githubusercontent.com/ChurchandLee/ubiquitous-guacamole/main/Eden.png" alt="Eden Avatar" class="ai-avatar">
                <div class="thinking-heart">üíö</div>
            `;
            
            chatArea.appendChild(typingDiv);
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        function hideTypingIndicator() {
            const existingIndicator = document.getElementById('currentTypingIndicator');
            if (existingIndicator) {
                existingIndicator.remove();
            }
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // Initialize app - THIS IS THE CRITICAL MISSING PIECE!
        document.addEventListener('DOMContentLoaded', function() {
            showDisclaimerModal(); // Show disclaimer first
            document.getElementById('messageInput').focus();
        });
    </script>
</body>
</html>
